---
layout: post
title:  "python函数调用堆栈分析"
categories: python
tags: python python-method
author: 大可
---

## 函数调用堆栈分析
我们都知道函数调用时会跳到指定函数执行，执行之后返回被调用处，那么python是如何记录相关信息并顺利执行的呢？

### 运行时栈
python使用运行时栈来实现这一过程，运行时栈包含两部分：调用框架(Call frames)又名活动记录(activation records)和本地变量存储(local variables)

#### 调用框架(Call frames/activation records)
- 调用框架是被留出的内存空间来跟踪正在执行的函数调用，调用框架在函数被调用时创建，在函数return时销毁
- 当调用一个函数时，在运行时栈顶新增一个调用框架，当从一个函数返回时，删除栈顶的调用框架
- 每个调用框架包含被调用函数名及被调用处的位置
- 初始化时候栈中有一个名为__main__的调用框架，随着函数调用，更多的调用框架被添加到其上，在栈顶的调用框架始终是当前正在执行的函数

#### 本地变量(Local variable)
- 被存储在栈上的本地变量是包含函数的形参的，当调用包含参数的函数时，形参使用实参的值作为初始化值来成为被调用参数的本地变量
- 随着函数的调用及函数中新参数的定义过程，参数被push到栈顶，当函数返回时，在该函数中定义的参数从栈中移除
- 调用框架和本地参数的push顺序是先push调用框架，故一个函数退出时，会不停地pop栈顶元素直到被调用函数的调用框架也被pop出栈。这样便圈定了当前local variable在栈中的位置范围，随着函数的执行，本地变量也可能会被改变，这时也为在栈中寻找指定本地变量并修改栈中对应变量的值提供了参考

#### 返回值
- 无论被调用函数是否有返回值，都会在push调用框架之前先在栈上预留返回值空间，并初始化为None，如果在被调用处有本地参数接收该返回值，那么在预留返回值空间之前会先初始化该本地参数为None
- 当执行return语句时，将return的值赋值给预留的返回值区域，然后结束该函数调用，本地参数和调用框架依次退栈，当要pop之前预留的返回值空间时，如果有参数接收该值，则在接收并进行相关计算后将结果赋值给接收参数，然后预留空间退栈

## 参考
- https://www.cs.ucsb.edu/~pconrad/cs8/topics.beta/theStack/

{:toc}